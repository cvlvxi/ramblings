(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0ab1a5"],{"149e":function(s,r,t){"use strict";t.r(r);var a=function(){var s=this,r=s.$createElement;s._self._c;return s._m(0)},e=[function(){var s=this,r=s.$createElement,t=s._self._c||r;return t("section",[t("ul",[t("li",[t("ol",[t("li",[t("a",{attrs:{href:"#Prereqs"}},[s._v("Prereqs")])])])]),t("li",[t("ol",{attrs:{start:"2"}},[t("li",[t("a",{attrs:{href:"#Gettingcompile_commands.json"}},[s._v("Getting compile_commands.json")])])])]),t("li",[t("ol",{attrs:{start:"3"}},[t("li",[t("a",{attrs:{href:"#Structure"}},[s._v("Structure")])])]),t("ul",[t("li",[s._v("3.1. "),t("a",{attrs:{href:"#Compilingandrunning"}},[s._v("Compiling and running")])])])]),t("li",[t("ol",{attrs:{start:"4"}},[t("li",[t("a",{attrs:{href:"#SortTests"}},[s._v("Sort Tests?")])])])]),t("li",[t("ol",{attrs:{start:"5"}},[t("li",[t("a",{attrs:{href:"#CanIlldbthis"}},[s._v("Can I lldb this?")])])]),t("ul",[t("li",[s._v("5.1. "),t("a",{attrs:{href:"#Setbreakinmain"}},[s._v("Set break in main")])]),t("li",[s._v("5.2. "),t("a",{attrs:{href:"#Run"}},[s._v("Run")])]),t("li",[s._v("5.3. "),t("a",{attrs:{href:"#IntergrationwithClion"}},[s._v("Intergration with Clion")])])])]),t("li",[t("ol",{attrs:{start:"6"}},[t("li",[t("a",{attrs:{href:"#Howdoessort_mainwork"}},[s._v("How does sort_main work?")])])]),t("ul",[t("li",[s._v("6.1. "),t("a",{attrs:{href:"#sort_blocks"}},[s._v("sort_blocks")])]),t("li",[s._v("6.2. "),t("a",{attrs:{href:"#buf_push"}},[s._v("buf_push")])]),t("li",[s._v("6.3. "),t("a",{attrs:{href:"#Debuggingnotworking"}},[s._v("Debugging not working?")])]),t("li",[s._v("6.4. "),t("a",{attrs:{href:"#args_targs"}},[s._v("args_t *args")])]),t("li",[s._v("6.5. "),t("a",{attrs:{href:"#bcf1_trecordstruct"}},[s._v("bcf1_t record struct")])]),t("li",[s._v("6.6. "),t("a",{attrs:{href:"#basedvs1-based"}},[s._v("0-based vs 1-based")])]),t("li",[s._v("6.7. "),t("a",{attrs:{href:"#BuffCapacity"}},[s._v("Buff Capacity?")])]),t("li",[s._v("6.8. "),t("a",{attrs:{href:"#buf_flush"}},[s._v("buf_flush")])]),t("li",[s._v("6.9. "),t("a",{attrs:{href:"#cmp_bcf_pos"}},[s._v("cmp_bcf_pos")])])])]),t("li",[t("ol",{attrs:{start:"7"}},[t("li",[t("a",{attrs:{href:"#Checkpoint:qsort"}},[s._v("Checkpoint: qsort")])])]),t("ul",[t("li",[s._v("7.1. "),t("a",{attrs:{href:"#PotentialAlgorithms"}},[s._v("Potential Algorithms")])]),t("li",[s._v("7.2. "),t("a",{attrs:{href:"#Whereevenisqsort"}},[s._v("Where even is qsort?")])]),t("li",[s._v("7.3. "),t("a",{attrs:{href:"#CanIaddmyownheaderfileintobcftools"}},[s._v("Can I add my own header file into bcftools?")])]),t("li",[s._v("7.4. "),t("a",{attrs:{href:"#inlineissues"}},[s._v("inline issues")])]),t("li",[s._v("7.5. "),t("a",{attrs:{href:"#Addedquadsortinvcfsort.c"}},[s._v("Added quadsort in vcfsort.c")])])])])]),t("h1",[s._v("Understanding bcftools sort")]),t("p",[s._v("All of the stuff I do will be in my own fork: "),t("a",{attrs:{href:"https://github.com/cvlvxi/bcftools"}},[s._v("here")])]),t("h2",[s._v("1. "),t("a",{attrs:{name:"Prereqs"}}),s._v("Prereqs")]),t("ul",[t("li",[s._v("Installed htslib (make installed)")]),t("li",[s._v("Built bcftools")]),t("li",[s._v("See "),t("a",{attrs:{href:"http://samtools.github.io/bcftools/howtos/install.html"}},[s._v("here")]),s._v(" for details")])]),t("h2",[s._v("2. "),t("a",{attrs:{name:"Gettingcompile_commands.json"}}),s._v("Getting compile_commands.json")]),t("p",[s._v("I'm using compiledb to actually generate the missing "),t("code",{pre:!0},[s._v("compile_commands.json")]),s._v(" file for clangd")]),t("p",[s._v("See "),t("a",{attrs:{href:"https://github.com/nickdiego/compiledb"}},[s._v("here")])]),t("p",[s._v("Make sure to run this first: "),t("code",{pre:!0},[s._v("autoreconf")])]),t("p",[s._v("Just run make with this wrapped which will target all")]),t("p",[t("code",{pre:!0},[s._v("compiledb make")])]),t("h2",[s._v("3. "),t("a",{attrs:{name:"Structure"}}),s._v("Structure")]),t("p",[s._v("Clearly we can see from the code "),t("code",{pre:!0},[s._v("vcfsort.c")]),s._v(" and it has a section in it called "),t("code",{pre:!0},[s._v("main_sort")])]),t("p",[s._v("Testing this works I added")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("main_sort")]),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" argc, "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("char")]),s._v(" *argv[])")]),s._v("\n")]),s._v("{\n    "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("printf")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"I am here"')]),s._v(");\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" c;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v(" *args  = ("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v("*) "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("calloc")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(","),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v("));\n    args->argc    = argc; args->argv = argv;\n    args->max_mem = "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("768")]),s._v("*"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1000")]),s._v("*"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1000")]),s._v(";\n")])]),t("h3",[s._v("3.1. "),t("a",{attrs:{name:"Compilingandrunning"}}),s._v("Compiling and running")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("./bcftools sort\n\nAbout:   Sort VCF/BCF file.\nUsage:   bcftools sort [OPTIONS] <FILE.vcf>\n\nOptions:\n    -m, --max-mem <"),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("float")]),s._v(">[kMG]    maximum memory to use [768M]\n    -o, --output <file>           output file name [stdout]\n    -O, --output-type <b|u|z|v>   b: compressed BCF, u: uncompressed BCF, z: compressed VCF, v: uncompressed VCF [v]\n    -T, --temp-dir <dir>          temporary files [/tmp/bcftools-sort.XXXXXX]\n\nI am here%\n")])]),t("p",[s._v("Sweet.")]),t("h2",[s._v("4. "),t("a",{attrs:{name:"SortTests"}}),s._v("Sort Tests?")]),t("ul",[t("li",[s._v("Can't find any? Might have to write some of my own I guess..")])]),t("p",[s._v("Test")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("./bcftools sort -o mytest/sorted.vcf mytest/unsorted.vcf \nWriting to /tmp/bcftools-sort.JRSJGT\nMerging 1 temporary files\nCleaning\nDone\nI am here%   \n")])]),t("h2",[s._v("5. "),t("a",{attrs:{name:"CanIlldbthis"}}),s._v("Can I lldb this?")]),t("h3",[s._v("5.1. "),t("a",{attrs:{name:"Setbreakinmain"}}),s._v("Set break in main")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":""}},[s._v("➜  bcftools git:(develop) ✗ lldb bcftools \nVoltron loaded.\n(lldb) target create \"bcftools\"\nCurrent executable set to '/path/to/bcftools' (x86_64).\n(lldb) run sort -o mytest/sorted.vcf mytest/unsorted.vcf \nProcess 17544 launched: '/path/to/bcftools' (x86_64)\nWriting to /tmp/bcftools-sort.PvWZtG\nMerging 1 temporary files\nCleaning\nDone\nI am hereProcess 17544 exited with status = 0 (0x00000000) \n(lldb) b vcfsort.c:318\nBreakpoint 1: where = bcftools`main_sort + 33 at vcfsort.c:319:31, address = 0x00000001000ae7a1\n(lldb) \n")])]),t("h3",[s._v("5.2. "),t("a",{attrs:{name:"Run"}}),s._v("Run")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("(lldb) run sort -o mytest/sorted.vcf mytest/unsorted.vcf\nProcess 17589 launched: "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'/path/to/bcftools'")]),s._v(" (x86_64)\nbcftools was compiled with optimization - stepping may behave oddly; variables may not be available.\nProcess 17589 stopped\n* thread "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("#1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1")]),s._v("\n    frame "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("#0: 0x00000001000ae7a1 bcftools`main_sort(argc=4, argv=0x00007ffeefbfecd8) at vcfsort.c:319:31 [opt]")]),s._v("\n   316  {\n   317      "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("printf")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"I am here"')]),s._v(");\n   318      int c;\n-> 319      args_t *args  = (args_t*) calloc(1,sizeof(args_t));\n   320      args->argc    = argc; args->argv = argv;\n   321      args->max_mem = 768*1000*1000;\n   322      args->output_fname = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"-"')]),s._v(";\nTarget 0: (bcftools) stopped.\n(lldb) \n\n")])]),t("p",[s._v("NICE!")]),t("h3",[s._v("5.3. "),t("a",{attrs:{name:"IntergrationwithClion"}}),s._v("Intergration with Clion")]),t("ol",[t("li",[s._v("Create a Custom build target (make cmd)")])]),t("img",{attrs:{src:"https://imgur.com/MnkE9w2.png"}}),t("ol",{attrs:{start:"2"}},[t("li",[s._v("Link the built executable and add the program args")])]),t("img",{attrs:{src:"https://imgur.com/7H1Ud5N.png"}}),t("ol",{attrs:{start:"3"}},[t("li",[s._v("Now try debug!")])]),t("img",{attrs:{src:"https://imgur.com/zbxQnr1.png"}}),t("p",[s._v("NICE!!!!")]),t("h2",[s._v("6. "),t("a",{attrs:{name:"Howdoessort_mainwork"}}),s._v("How does sort_main work?")]),t("ol",[t("li",[s._v("init(args)")]),t("li",[s._v("sort_blocks(args) "),t("ul",[t("li",[s._v("Reads the file with hts_open")])])])]),t("h3",[s._v("6.1. "),t("a",{attrs:{name:"sort_blocks"}}),s._v("sort_blocks")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("sort_blocks")]),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v(" *args)")]),s._v(" \n")]),s._v("{\n    htsFile *in = hts_open(args->fname, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"r"')]),s._v(");\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( !in ) clean_files_and_throw(args, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"Could not read %s\\n"')]),s._v(", args->fname);\n    args->hdr = bcf_hdr_read(in);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( !args->hdr) clean_files_and_throw(args, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"Could not read VCF/BCF headers from %s\\n"')]),s._v(", args->fname);\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("while")]),s._v(" ( "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(" )\n    {\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(" *rec = bcf_init();\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" ret = bcf_read1(in, args->hdr, rec);\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( ret < "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("-1")]),s._v(" ) clean_files_and_throw(args,"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"Error encountered while parsing the input\\n"')]),s._v(");\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( ret == "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("-1")]),s._v(" )\n        {\n            bcf_destroy(rec);\n            "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("break")]),s._v(";\n        }\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( rec->errcode ) clean_files_and_throw(args,"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"Error encountered while parsing the input at %s:%d\\n"')]),s._v(",bcf_seqname(args->hdr,rec),rec->pos+"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(");\n        buf_push(args, rec);\n    }\n    buf_flush(args);\n    "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("free")]),s._v("(args->buf);\n")])]),t("ul",[t("li",[s._v("Note key htslib functions called")]),t("li",[t("code",{pre:!0},[s._v("bcf_hdr_read")]),s._v(" reading the vcf header and storing in args->hdr")]),t("li",[s._v("Creates a new rec in the while loop for each row "),t("ul",[t("li",[s._v("When ret is 0 we keep going otherwise we break or destroy")])])])]),t("p",[s._v("Here we're getting to the meat of the sort")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[s._v("buf_push(args, rec);\n")])]),t("h3",[s._v("6.2. "),t("a",{attrs:{name:"buf_push"}}),s._v("buf_push")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("buf_push")]),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v(" *args, "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(" *rec)")]),s._v("\n")]),s._v("{\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" delta = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(") + rec->shared.l + rec->indiv.l + "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v("*);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( args->mem + delta > args->max_mem ) buf_flush(args);\n    args->nbuf++;\n    args->mem += delta;\n    hts_expand("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v("*, args->nbuf, args->mbuf, args->buf);\n    args->buf[args->nbuf"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("-1")]),s._v("] = rec;\n}\n\n")])]),t("p",[s._v("So it will calculate the amount of memory to add in delta which is size of a record + the shared and indiv size_t + size of record ptr")]),t("p",[s._v("args->nbuf increments (amount of records)")]),t("p",[s._v("args->mem total memory")]),t("p",[s._v("Add to args->buf the record")]),t("h3",[s._v("6.3. "),t("a",{attrs:{name:"Debuggingnotworking"}}),s._v("Debugging not working?")]),t("ul",[t("li",[s._v("Noticing at certain breakpoints can't get the full evaluation context..")]),t("li",[t("code",{pre:!0},[s._v("CFLAGS=-g -O2")])]),t("li",[s._v("Let's turn Optimisation to "),t("code",{pre:!0},[s._v("CFLAGS = -g - Wall -O0")]),s._v(" in makefile")])]),t("p",[s._v("OK NOW THIS WORKS NICE")]),t("h3",[s._v("6.4. "),t("a",{attrs:{name:"args_targs"}}),s._v("args_t *args")]),t("p",[s._v("This is passed all over the place ... what is it?")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v(" *args  = ("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v("*) "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("calloc")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(","),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v("));\n")])]),t("p",[s._v("where")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-class"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("struct")]),s._v(" _"),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("args_t")]),s._v("\n{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf_hdr_t")]),s._v(" *hdr;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("char")]),s._v(" **argv, *fname, *output_fname, *tmp_dir;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" argc, output_type;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("size_t")]),s._v(" max_mem, mem;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(" **buf;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("size_t")]),s._v(" nbuf, mbuf, nblk;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("blk_t")]),s._v(" *blk;\n}\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v(";\n")])]),t("p",[s._v("Let's not forget what "),t("code",{pre:!0},[s._v("bcf1_t")]),s._v(" is for a record")]),t("h3",[s._v("6.5. "),t("a",{attrs:{name:"bcf1_trecordstruct"}}),s._v("bcf1_t record struct")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-class"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("bcf1_t")]),s._v(" {")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("hts_pos_t")]),s._v(" pos;  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// POS")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("hts_pos_t")]),s._v(" rlen; "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// length of REF")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int32_t")]),s._v(" rid;  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// CHROM")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("float")]),s._v(" qual;   "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// QUAL")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("uint32_t")]),s._v(" n_info:"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("16")]),s._v(", n_allele:"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("16")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("uint32_t")]),s._v(" n_fmt:"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("8")]),s._v(", n_sample:"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("24")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("kstring_t")]),s._v(" shared, indiv;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf_dec_t")]),s._v(" d; "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// lazy evaluation: $d is not generated by bcf_read(), but by explicitly calling bcf_unpack()")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" max_unpack;         "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Set to BCF_UN_STR, BCF_UN_FLT, or BCF_UN_INFO to boost performance of vcf_parse when some of the fields won't be needed")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" unpacked;           "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// remember what has been unpacked to allow calling bcf_unpack() repeatedly without redoing the work")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" unpack_size["),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("3")]),s._v("];     "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// the original block size of ID, REF+ALT and FILTER")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" errcode;    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// one of BCF_ERR_* codes")]),s._v("\n} "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(";\n")])]),t("h3",[s._v("6.6. "),t("a",{attrs:{name:"basedvs1-based"}}),s._v("0-based vs 1-based")]),t("img",{attrs:{src:"https://imgur.com/btv2ZNS.png"}}),t("p",[s._v("This may be entirely obvious but you can see that the VCF file displays 1 based counting vs bcftools / htslib has the position at 0 based counting")]),t("p",[s._v("Interestingly this also applies to rid aka CHROM")]),t("img",{attrs:{src:"https://imgur.com/iei4WDz.png"}}),t("h3",[s._v("6.7. "),t("a",{attrs:{name:"BuffCapacity"}}),s._v("Buff Capacity?")]),t("p",[s._v("Look here")]),t("img",{attrs:{src:"https://imgur.com/oAkXjEv.png"}}),t("p",[s._v("You can see buf has 14 elements.. but we've passed the number since there are > 14 variants so what's going on???")]),t("p",[s._v("Ok I figured out why... lldb in "),t("code",{pre:!0},[s._v("clion only shows a limited amount")]),s._v(" to actually see more you can do this in the lldb console..")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("(lldb) v *args->buf[20]\n(bcf1_t) *args->buf[20] = {\n  pos = 219418536\n  rlen = 1\n  rid = 1\n  qual = 1065.77002\n  n_info = 17\n  n_allele = 2\n  n_fmt = 5\n  n_sample = 1\n  shared = (l = 114, m = 151, s = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"\\x97rs1318299\\x17A\\x17G"')]),s._v(")\n  indiv = (l = 27, m = 40, s = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"\\x11\\x05!\\x04\\x04\\x11\\x02!"')]),s._v(")\n  d = {\n    m_fmt = 0\n")])]),t("p",[s._v("which does correspond to a variant further down the list... Phew")]),t("h3",[s._v("6.8. "),t("a",{attrs:{name:"buf_flush"}}),s._v("buf_flush")]),t("ul",[t("li",[s._v("After processing all variants calls this")])]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("buf_flush")]),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("args_t")]),s._v(" *args)")]),s._v("\n")]),s._v("{\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( !args->nbuf ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(";\n\n    qsort(args->buf, args->nbuf, "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("(*args->buf), cmp_bcf_pos);\n\n    args->nblk++;\n    args->blk = ("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("blk_t")]),s._v("*) "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("realloc")]),s._v("(args->blk, "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("blk_t")]),s._v(")*args->nblk);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("blk_t")]),s._v(" *blk = args->blk + args->nblk - "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(";\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("kstring_t")]),s._v(" str = {"),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(","),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(","),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("};\n    ksprintf(&str, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"%s/%05d.bcf"')]),s._v(", args->tmp_dir, ("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(")args->nblk);\n    blk->fname = str.s;\n    blk->rec   = "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("NULL")]),s._v(";\n    blk->fh    = "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("NULL")]),s._v(";\n\n    htsFile *fh = hts_open(blk->fname, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"wbu"')]),s._v(");\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( fh == "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("NULL")]),s._v(" ) clean_files_and_throw(args, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"Cannot write %s: %s\\n"')]),s._v(", blk->fname, strerror(errno));\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( bcf_hdr_write(fh, args->hdr)!="),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(" ) clean_files_and_throw(args, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"[%s] Error: cannot write to %s\\n"')]),s._v(", __func__,blk->fname);\n    \n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" i;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("for")]),s._v(" (i="),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("; i<args->nbuf; i++)\n    {\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( bcf_write(fh, args->hdr, args->buf[i])!="),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(" ) clean_files_and_throw(args, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"[%s] Error: cannot write to %s\\n"')]),s._v(", __func__,blk->fname);\n        bcf_destroy(args->buf[i]);\n    }\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( hts_close(fh)!="),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(" ) clean_files_and_throw(args, "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"[%s] Error: close failed .. %s\\n"')]),s._v(", __func__,blk->fname);\n\n    args->nbuf = "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n    args->mem  = "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n}\n")])]),t("ul",[t("li",[s._v("qsort see here "),t("a",{attrs:{href:"https://www.tutorialspoint.com/c_standard_library/c_function_qsort.htm"}},[s._v("https://www.tutorialspoint.com/c_standard_library/c_function_qsort.htm")])])]),t("p",[t("code",{pre:!0},[s._v("void qsort(void *base, size_t nitems, size_t size, int (*compar)(const void *, const void*))")])]),t("ul",[t("li",[s._v("base − This is the pointer to the first element of the array to be sorted.")]),t("li",[s._v("nitems − This is the number of elements in the array pointed by base.")]),t("li",[s._v("size − This is the size in bytes of each element in the array.")]),t("li",[s._v("compar − This is the function that compares two elements.")])]),t("p",[s._v("COOL")]),t("p",[s._v("and our callsite?")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[s._v("qsort(args->buf, args->nbuf, "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("sizeof")]),s._v("(*args->buf), cmp_bcf_pos);\n")])]),t("h3",[s._v("6.9. "),t("a",{attrs:{name:"cmp_bcf_pos"}}),s._v("cmp_bcf_pos")]),t("p",[s._v("We've hit the place where some sorting is happening boiz!!")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-c"}},[t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title"}},[s._v("cmp_bcf_pos")]),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("void")]),s._v(" *aptr, "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("void")]),s._v(" *bptr)")]),s._v("\n")]),s._v("{\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(" *a = *(("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v("**)aptr);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v(" *b = *(("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("bcf1_t")]),s._v("**)bptr);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( a->rid < b->rid ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("-1")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( a->rid > b->rid ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( a->pos < b->pos ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("-1")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( a->pos > b->pos ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(";\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Sort the same chr:pos records lexicographically by ref,alt.")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// This will be called rarely so should not slow the sorting down")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// noticeably.")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( !a->unpacked ) bcf_unpack(a, BCF_UN_STR);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( !b->unpacked ) bcf_unpack(b, BCF_UN_STR);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" i;\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("for")]),s._v(" (i="),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("; i<a->n_allele; i++)\n    { \n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( i >= b->n_allele ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("1")]),s._v(";\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("int")]),s._v(" ret = strcasecmp(a->d.allele[i],b->d.allele[i]);\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( ret ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" ret;\n    }\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" ( a->n_allele < b->n_allele ) "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("-1")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(";\n}\n")])]),t("p",[s._v("How it chooses which records is unclear as it's most probably left to qsort...")]),t("p",[s._v("HOWEVER")]),t("p",[s._v("we can see the comparison it does iternally...")]),t("ol",[t("li",[s._v("CHROM CHECK "),t("ul",[t("li",[s._v("CHROM LEFT < RIGHT? return -1")]),t("li",[s._v("CHROM LEFT > RIGHT? return 1")])])]),t("li",[s._v("CHECK POSITION "),t("ul",[t("li",[s._v("POSITION LEFT < RIGHT? return -1")]),t("li",[s._v("POSITION LEFT > RIGHT? return 1")])])]),t("li",[s._v("CHECK ALLELE..")])]),t("h2",[s._v("7. "),t("a",{attrs:{name:"Checkpoint:qsort"}}),s._v("Checkpoint: qsort")]),t("ul",[t("li",[s._v("Ok so we can see at this point that we're doing quick sort..")]),t("li",[s._v("Now comes the fun part.. what if we used a different algorithm?")])]),t("h3",[s._v("7.1. "),t("a",{attrs:{name:"PotentialAlgorithms"}}),s._v("Potential Algorithms")]),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/patperry/timsort"}},[s._v("Timsort")])]),t("li",[t("a",{attrs:{href:"https://github.com/scandum/quadsort"}},[s._v("Quadsort")])])]),t("h3",[s._v("7.2. "),t("a",{attrs:{name:"Whereevenisqsort"}}),s._v("Where even is qsort?")]),t("p",[s._v("Looks like it's part of stdlib.h")]),t("p",[s._v("See here: "),t("a",{attrs:{href:"https://www.tutorialspoint.com/c_standard_library/stdlib_h.htm"}},[s._v("stdlib.h")])]),t("h3",[s._v("7.3. "),t("a",{attrs:{name:"CanIaddmyownheaderfileintobcftools"}}),s._v("Can I add my own header file into bcftools?")]),t("p",[s._v("Makefile")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":""}},[s._v("\nCUSTOM_SORT_H = customsort/quadsort.h\n...\n\n\nvcfsort.o: vcfsort.c $(htslib_vcf_h) $(htslib_kstring_h) $(htslib_hts_os_h) kheap.h $(bcftools_h) $(CUSTOM_SORT_H)\n")])]),t("p",[s._v("Error")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":""}},[s._v('cd ../htslib && /Applications/Xcode.app/Contents/Developer/usr/bin/make lib-static\nmake[2]: Nothing to be done for `lib-static\'.\ngcc -rdynamic   -o bcftools main.o vcfindex.o tabix.o vcfstats.o vcfisec.o vcfmerge.o vcfquery.o vcffilter.o filter.o vcfsom.o vcfnorm.o vcfgtcheck.o vcfview.o vcfannotate.o vcfroh.o vcfconcat.o vcfcall.o mcall.o vcmp.o gvcf.o reheader.o convert.o vcfconvert.o tsv2vcf.o vcfcnv.o HMM.o consensus.o ploidy.o bin.o hclust.o version.o regidx.o smpl_ilist.o csq.o vcfbuf.o mpileup.o bam2bcf.o bam2bcf_indel.o bam_sample.o vcfsort.o cols.o extsort.o ccall.o em.o prob1.o kmin.o  vcfplugin.o ../htslib/libhts.a -lz -lm -lbz2 -llzma -lcurl -lm -lz     -lpthread\nUndefined symbols for architecture x86_64:\n  "_tail_insert32", referenced from:\n      _tail_swap32 in vcfsort.o\n  "_tail_insert64", referenced from:\n      _tail_swap64 in vcfsort.o\nld: symbol(s) not found for architecture x86_64\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\nmake[1]: *** [bcftools] Error 1\n## Building [make]...\n\nmake: *** [me] Error 1\n')])]),t("h3",[s._v("7.4. "),t("a",{attrs:{name:"inlineissues"}}),s._v("inline issues")]),t("ul",[t("li",[s._v("There seems to be some issues with using inline functions and C99 and bcftools so I removed them from quadsort")])]),t("h3",[s._v("7.5. "),t("a",{attrs:{name:"Addedquadsortinvcfsort.c"}}),s._v("Added quadsort in vcfsort.c")]),t("p",[s._v("See "),t("a",{attrs:{href:"https://github.com/cvlvxi/bcftools/commit/d7f003a42b961dfedb4207be55b92041b1246c9e"}},[s._v("This github commit")])]),t("p",[s._v("We can see some difference in performance around ~ 4seconds for a 4.5Gig VCF file")])])}],n=t("2877"),l={},_=Object(n["a"])(l,a,e,!1,null,null,null);r["default"]=_.exports}}]);