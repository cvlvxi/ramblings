# Cmake 

For a little while now, I have been using CMake as a build tool for building C++ programs. My experience with CMake hasn't been a favorable one compared to say, Meson build, which is clearer but has less complexity and ability to do custom things. 

Since I find myself questioning myself whenever I have to redo a Cmake project I thought it'd be worth encapsulating some of the more common problems here as I way of guiding my future self or anyone who might by chance read this.

## Problem 1. Adding External Dependencies

You have a library you want to include. If the library supplies headerfiles you could just download those and include it as part of your src. However if it it has a CmakeLists.txt in the root. What to do?

You can use a `ExternalProject` dependency to: `git fetch or download the src` and it can `then build the project giving you the static / dynamic libraries` that you can link to your executable.

Here's an example github project that shows use of this: https://github.com/charlesnicholson/cmake-external-project-test/blob/master/CMakeLists.txt


```
set(HIDAPI_ROOT ${CMAKE_BINARY_DIR}/thirdparty/hidapi)
set(HIDAPI_LIB_DIR ${HIDAPI_ROOT}/bin/lib)
set(HIDAPI_INCLUDE_DIR ${HIDAPI_ROOT}/bin/include)

include(ExternalProject)

ExternalProject_Add(hidapi_external
                    PREFIX ${HIDAPI_ROOT}
                    GIT_REPOSITORY "https://github.com/signal11/hidapi.git"
                    GIT_TAG "40cf516139b5b61e30d9403a48db23d8f915f52c"
                    UPDATE_COMMAND ""
                    PATCH_COMMAND ""
                    BINARY_DIR ${HIDAPI_ROOT}/src/hidapi
                    SOURCE_DIR ${HIDAPI_ROOT}/src/hidapi
                    INSTALL_DIR ${HIDAPI_ROOT}/bin
                    CONFIGURE_COMMAND ./configure --prefix=<INSTALL_DIR>
                    BUILD_COMMAND make
                    BUILD_BYPRODUCTS ${HIDAPI_LIB_DIR}/libhidapi.a)
```

It's sets some key variables used in where the src is downloaded to, which git repo, tag etc and configurations as to how it will build which can be customized. 

## Real world Example:

We have this repo: https://github.com/ggerganov/imtui

How can we add this to our executable? 

## Create contrib/imtui.cmake 

With the following

```
set(imtui_PREFIX ${CMAKE_BINARY_DIR}/contrib/imtui-prefix)
set(imtui_DIR ${imtui_PREFIX}/src/imtui)
set(imtui_INCLUDE ${imtui_DIR}/include)
set(imtui_SRC ${imtui_DIR}/src)
set(imtui_BINARY_DIR ${imtui_PREFIX}/bin)


include(ExternalProject)

ExternalProject_Add(imtui
    PREFIX ${imtui_PREFIX}
    GIT_REPOSITORY "https://github.com/ggerganov/imtui.git"
    GIT_TAG        "master"
    UPDATE_COMMAND ""
    PATCH_COMMAND ""
    BINARY_DIR ${imtui_BINARY_DIR}
    BUILD_COMMAND make
    INSTALL_COMMAND ""
    # CONFIGURE_COMMAND ""
    # BUILD_COMMAND ${MAKE_COMMAND} lib-static
    # INSTALL_COMMAND ${MAKE_COMMAND} install prefix=${htslib_INSTALL}
    LOG_DOWNLOAD 1
)
```

Add to root CmakeLists.txt:

```
cmake_minimum_required(VERSION 3.17)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

project(stonks)

include("./contrib/imtui.cmake")

message(STATUS ${imtui_INCLUDE})

add_executable(main src/main.cpp)
add_dependencies(main imtui)
```

Note the following:

- When we use external depedency we need to declare on the project the dependency see: `add_dependencies(main imtui)`

Problem: 

```
[100%] Linking CXX executable ../../bin/hnterm
[100%] Built target hnterm
[ 70%] Performing install step for 'imtui'
make[3]: *** No rule to make target `install'.  Stop.
make[2]: *** [contrib/imtui-prefix/src/imtui-stamp/imtui-install] Error 2
make[1]: *** [CMakeFiles/imtui.dir/all] Error 2
```

In the ExternalProject config add

```
    INSTALL_COMMAND "" 
```

Empty denoted it will not do anything



# Links
- [Advanced Levelization Techniques p 1](https://www.youtube.com/watch?v=QjFpKJ8Xx78)
- [Using modern cmake patterns to enforce good modular design](https://www.youtube.com/watch?v=eC9-iRN2b04)
- [Effective CMake](https://www.youtube.com/watch?v=bsXLMQ6WgIk)